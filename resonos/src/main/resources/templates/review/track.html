<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/main_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="|${track.title} Î¶¨Î∑∞|">Ìä∏Îûô Î¶¨Î∑∞</title>
    <th:block th:replace="~{fragments/link::album}"></th:block>
</head>

<body layout:fragment="content">
    <div class="wrapper">
        <!-- Ìä∏Îûô Ïπ¥Îìú -->
        <div class="song-card">
            <div class="song-overall">
                <div class="song-img">
                    <img th:src="@{${album.coverImage}}" alt="">
                    <span class="center-pin"></span>
                </div>
            </div>
            <div class="song-info">
                <p id="headline" th:text="${track.title}">Ìä∏ÎûôÎ™Ö</p>
                <a th:href="@{artists(id=${artist.id})}">
                    <p th:text="${artist.name}">ÏïÑÌã∞Ïä§Ìä∏</p>
                </a>
                <p th:text="${#dates.format(album.releaseDate, 'yyyy-MM-dd')}">Î∞úÎß§Ïùº</p>
                <a th:href="@{/albums(id=${album.id})}">
                    <p th:text="|${album.title}üíøÏùò ${track.trackNo}th track|">Ïñ¥ÎîîÏï®Î≤îÏùò Î™áÎ≤àÏß∏Í≥°</p>
                </a>
                <th:block th:if="${score == null or score.averageScore == null}">
                    <p>ÏïÑÏßÅ Î¶¨Î∑∞Í∞Ä ÏóÜÏñ¥Ïöî üòÖ</p>
                </th:block>
                <th:block th:if="${score != null and score.averageScore != null}">
                    <p
                        th:text="|üîÆ ${#numbers.formatDecimal(score.averageScore, 0, 0)}Ï†ê (‚úÖÎ¶¨Î∑∞ ${score.criticCount}Í∞ú, ÏùºÎ∞òÎ¶¨Î∑∞ ${score.userCount}Í∞ú)|">
                    </p>
                </th:block>
                <div>
                    <div class="btn btn-gold">Ï¢ãÏïÑÏöî ‚ù§Ô∏è</div>
                    <div class="btn btn-gold">Ï†ÄÏû• üíæ</div>
                </div>
            </div>
        </div>
        <!-- Ìä∏Îûô Ïπ¥Îìú ÎÅù -->
        <!-- iframe -->
        <div class="iframe-card">
            <div class="spotify">
                <!-- Ïä§Ìè¨Ìã∞ÌååÏù¥ Î°úÍ∑∏Ïù∏ ÎêòÏñ¥ÏûàÏßÄÏïäÏùÑÎïå 30Ï¥à ÎØ∏Î¶¨Îì£Í∏∞ Ïò§ÎîîÏò§ÌÉúÍ∑∏ -->
                <iframe th:src="|https://open.spotify.com/embed/track/${track.id}?utm_source=generator|" frameborder="0"
                    allowfullscreen allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                    loading="lazy">
                </iframe>
            </div>
            <div class="youtube">
                <th:block th:if="${!#strings.isEmpty(track.mvUrl)}">
                    <iframe width="560" height="315" th:src="|https://www.youtube.com/embed/${track.mvUrl}|"
                        title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
                    </iframe>
                </th:block>
                <!-- ‚ë° MV URLÏù¥ ÏóÜÏùÑ Îïå ‚Üí Ï§ÄÎπÑÏ§ë Ïù¥ÎØ∏ÏßÄ -->
                <th:block th:if="${#strings.isEmpty(track.mvUrl)}">
                    <img th:src="@{/img/wait_plz.png}" alt="ÎÆ§ÏßÅÎπÑÎîîÏò§ Ï§ÄÎπÑÏ§ë" width="560" height="315"
                        style="object-fit:cover;">
                </th:block>
            </div>
        </div>
        <!-- iframe Ïπ¥Îìú ÎÅù -->

        <!-- ÌèâÏ†ê&Î¶¨Î∑∞ -->
        <div class="review-card">
            <p id="headline">ÌèâÏ†ê & Î¶¨Î∑∞</p>
            <div th:fragment="scoreFragment">
                <div class="review-score">
                    <th:block th:if="${score == null or score.averageScore == null}">
                        <h1 id="headline">Ï≤´ Î¶¨Î∑∞Î•º ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî ü§©</h1>
                    </th:block>
                    <th:block th:if="${score != null and score.averageScore != null}">
                        <h1 id="headline" th:text="|üîÆ ${#numbers.formatDecimal(score.averageScore, 0, 0)}|"></h1>
                        <div class="score-bar">
                            <div class="score-fill"
                                th:style="'width:' + ${#numbers.formatDecimal(score.averageScore, 1, 1)} + '%'">
                                <span th:text="${#numbers.formatDecimal(score.averageScore, 0, 0)}"></span>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
            <div class="review-container">
                <!-- <ul class="review-list">
                    <th:block th:each="rv : ${review}">
                        <li class="comment" th:id="|rv-${rv.id}|" th:data-review-id="${rv.id}"
                            th:data-track-id="${track.id}">
                            <div class="name-and-score">
                                <p th:text="${rv.reviewer.nickname}">ÎãâÎÑ§ÏûÑ</p>
                                <span th:if="${rv.critic == true }">‚úÖ</span>
                                <span> üîÆ<span th:text="${rv.rating}">0</span></span>
                            </div>
                            <div class="review-content">
                                <p class="content-text" th:text="${rv.content}">ÎÇ¥Ïö©</p>
                            </div>
                            <form class="edit-form" style="display: none;">
                                <div class="reply">
                                    <textarea class="edit-content" required></textarea>
                                    <div class="score-and-submit">
                                        <input type="number" class="edit-rating" min="0" max="100" required>
                                        <div class="button-box">
                                            <button type="submit" class="btn btn-gold">ÏàòÏ†ï ÏôÑÎ£å</button>
                                            <button type="button" class="btn btn-danger">Ï∑®ÏÜå</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="review-util">
                                <time th:text="${#temporals.format(rv.createdAt,'yyyy.MM.dd')}">ÎÇ†Ïßú</time>
                                <button class="like-btn" th:data-review-id="${rv.id}"
                                    th:data-review-type="${reviewType}" th:data-liked="${rv.isLikedByCurrentUser}"
                                    th:text="${rv.isLikedByCurrentUser} ? '‚ù§Ô∏è' : 'ü§ç'">‚ù§Ô∏è</button>

                                <span th:id="'like-count-' + ${rv.id}" th:text="${rv.likes}">0</span>

                                <button class="report-btn" th:data-review-id="${rv.id}"
                                    th:data-review-type="${reviewType}">üö®</button>
                                <span
                                    th:if="${(isAdmin != null and isAdmin) or (loginUser != null and rv != null and loginUser.id == rv.userId)}">
                                    <a href="#" class="edit-btn" th:data-id="${rv.id}">ÏàòÏ†ï</a>
                                    <a href="#" class="del-btn" th:data-id="${rv.id}">ÏÇ≠Ï†ú</a>
                                </span>
                            </div>
                        </li>
                    </th:block>
                </ul> -->
                <ul class="review-list" th:insert="~{review/trackFrag :: reviewItems(review=${review})}"></ul>
                <!-- ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº -->
                <div class="more-box" th:if="${hasNext}">
                    <button id="load-more-btn" data-page="1" th:data-track-id="${track.id}" class="btn btn-gold">Î¶¨Î∑∞
                        ÎçîÎ≥¥Í∏∞</button>
                </div>
                <form class="edit-form" style="display: none;">
                    <div class="reply">
                        <textarea class="edit-content" required></textarea>
                        <div class="score-and-submit">
                            <input type="number" class="edit-rating" min="0" max="100" required />
                            <div class="button-box">
                                <button type="submit" class="btn btn-gold">ÏàòÏ†ï ÏôÑÎ£å</button>
                                <button type="button" class="btn btn-danger">Ï∑®ÏÜå</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò -->
            <div th:if="${loginUser != null}" class="reply">
                <form id="reviewForm">
                    <input type="hidden" id="trackId" th:value="${track.id}">
                    <textarea id="content" placeholder="Î¶¨Î∑∞Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî" required></textarea>
                    <div class="score-and-submit">
                        <input type="number" id="rating" min="0" max="100" placeholder="0~100Ï†ê" required>
                        <button type="submit" class="btn btn-gold">Î¶¨Î∑∞ÏûëÏÑ±</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- ÌèâÏ†ê&Î¶¨Î∑∞ ÎÅù -->

        <!-- Î∂ÑÏúÑÍ∏∞ -->
        <div class="mood-card">
            <div class="chart">
                <canvas id="hexRadarChart"></canvas>
            </div>
            <div class="mood-vote">
                <div class="vote-header">
                    <p id="headline">Mood Tag</p>
                </div>
                <div class="moods">
                    <!-- Î∂ÑÏúÑÍ∏∞ Î∞òÎ≥µÎ¨∏ -->
                    <div class="btn btn-gold">Î∂ÑÏúÑÍ∏∞1</div>
                    <div class="btn btn-gold">Î∂ÑÏúÑÍ∏∞1324</div>
                    <div class="btn btn-gold">Î∂ÑÏúÑÍ∏∞133</div>
                    <div class="btn btn-gold">Î∂ÑÏúÑÍ∏∞1</div>
                    <div class="btn btn-gold">Î∂ÑÏúÑÍ∏∞144</div>
                    <div class="btn btn-gold">Î∂ÑÏúÑÍ∏∞1</div>
                </div>
                <button class="btn btn-gold">Î∂ÑÏúÑÍ∏∞ Ìà¨Ìëú</button>
            </div>
        </div>
        <!-- Î∂ÑÏúÑÍ∏∞ ÎÅù -->

        <!-- Ïï®Î≤î Ìä∏ÎûôÎ¶¨Ïä§Ìä∏ Î∂ÑÏúÑÍ∏∞ Î≠êÎ≠ê.. -->
        <div class="info-card">
            <div class="info top5track">
                <p id="headline" th:text="|${album.title}üíø üî•TOP ${#lists.size(top5List)}|"></p>
                <th:block th:each="tops, stat : ${top5List}">
                    <a th:href="@{/tracks(id=${tops.id})}">
                        <p th:text="|${stat.count}. ${tops.title}  ${tops.formattedDuration}|"></p>
                    </a>
                </th:block>
            </div>
            <div class="info album-moods">
                <p id="headline">Ìä∏ÎûôÏùò Î∂ÑÏúÑÍ∏∞</p>
                <div class="mood-list">
                    <button class="btn btn-gold">ÎèôÌï¥Î¨ºÍ≥º23</button>
                    <button class="btn btn-gold">Î∞±ÎëêÏÇ∞Ïù¥ ÎßàÎ•¥Í≥†</button>
                    <button class="btn btn-gold">Îã≥ÎèÑÎ°ù ÌïòÎäê</button>
                    <button class="btn btn-gold">Îã≥ÎèÑÎ°ù ÌïòÎäê</button>
                </div>
            </div>
            <div class="info pl-list">
                <p id="subtitle">Ïù¥ Ìä∏ÎûôÏùÑ Ìè¨Ìï®Ìïú ÌîåÎ¶¨üé∂</p>
                <p>Ïò§Îäò Ìó§Ïñ¥ÏßÑ ÏÇ¨ÎûåÎì§ÏùÄ ÏúÑÌïú ÌîåÎ¶¨ ‚ù§352</p>
                <p>ÌòºÏûêÏûàÍ≥† Ïã∂Ïñ¥Ïöî,, ‚ù§242</p>
                <p>üò¢üò¢üò¢üò¢üò¢üò¢üò¢üò¢üò¢ ‚ù§122</p>
                <p>ÌéòÌéòÏÇ¨ÎûëÎã® ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ ‚ù§64</p>
            </div>
        </div>
        <!-- Ïï®Î≤î Ìä∏ÎûôÎ¶¨Ïä§Ìä∏ Î∂ÑÏúÑÍ∏∞ Î≠êÎ≠ê..ÎÅù -->

    </div>
    <th:block th:replace="~{fragments/script::album}"></th:block>
    <script th:inline="javascript">
        const isLogin = [[${ loginUser != null ? 'true' : 'false'}]];
    </script>
    <script>
        $(document).ready(function () {
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
            const csrfToken = $('meta[name="_csrf"]').attr('content');

            // CSRF ÏÑ§Ï†ï
            $.ajaxSetup({
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                }
            });
            // Ï†êÏàò Î∂ÄÎ∂ÑÎßå ÏÉàÎ°úÍ≥†Ïπ®
            function reloadScoreBox(trackId) {
                $.ajax({
                    url: `/tracks/${trackId}/score-fragment`,
                    type: 'GET',
                    success: function (html) {
                        $('.review-score').html(html);

                    },
                    error: function () {
                        console.error("Ï†êÏàò Í∞±Ïã† Ïã§Ìå®");
                    }
                });
            }
            /** ‚ë† Îì±Î°ù */
            $('#reviewForm').on('submit', function (e) {
                e.preventDefault();

                const trackId = $('#trackId').val();
                const content = $('#content').val().trim();
                const rating = $('#rating').val();

                if (content === '' || rating === '') {
                    Swal.fire({
                        title: 'Î¶¨Î∑∞Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî',
                        text: 'Î¶¨Î∑∞Î•º ÏûÖÎ†•ÌïòÏßÄ ÏïäÏúºÏÖ®ÏäµÎãàÎã§.',
                        icon: 'error',
                        confirmButtonText: 'ÌôïÏù∏'
                    });
                    return;
                }

                $.ajax({
                    url: `/tracks?id=${trackId}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ content, rating }),
                    success: function () {
                        Swal.fire({
                            title: 'ÏÑ±Í≥µ',
                            text: 'Î¶¨Î∑∞Î•º Îì±Î°ù ÌïòÏòÄÏäµÎãàÎã§.',
                            icon: 'success',
                            confirmButtonText: 'ÌôïÏù∏'
                        }).then(() => {
                            reloadScoreBox(trackId);  // Ï†êÏàò Î∞ïÏä§ Î®ºÏ†Ä Îã§Ïãú Î∂àÎü¨Ïò§Í≥†
                            location.reload();        // ÏÉàÎ°úÍ≥†Ïπ®
                        });
                    },
                    error: function (xhr) {
                        if (xhr.status === 409) {
                            Swal.fire({
                                title: 'Ï§ëÎ≥µ',
                                text: 'Ïù¥ÎØ∏ Î¶¨Î∑∞Î•º ÏûëÏÑ±ÌñàÏäµÎãàÎã§.',
                                icon: 'warning',
                                confirmButtonText: 'ÌôïÏù∏'
                            });
                        } else {
                            Swal.fire({
                                title: 'Ïò§Î•ò',
                                text: 'Î¶¨Î∑∞ Îì±Î°ù Ï§ë Ïò§Î•ò Î∞úÏÉù.',
                                icon: 'error',
                                confirmButtonText: 'ÌôïÏù∏'
                            });
                        }
                    }
                });
            });

            /** ‚ë° ÏàòÏ†ï Î≤ÑÌäº ÌÅ¥Î¶≠ ‚Üí Ìèº Ïó¥Í∏∞ + Í∏∞Ï°¥ ÎÇ¥Ïö© Ï±ÑÏö∞Í∏∞ */
            $(document).on('click', '.edit-btn', function (e) {
                e.preventDefault();

                const li = $(this).closest('li');
                const reviewId = li.attr('data-review-id');
                const trackId = li.attr('data-track-id');
                const contentText = li.find('.content-text');
                const content = contentText.text().trim();
                const rating = li.find('.name-and-score span span').text().trim();
                // ÌÖçÏä§Ìä∏ Ïà®Í∏∞Í≥† Ìèº Î≥¥Ïó¨Ï§å
                contentText.slideUp(200);
                li.find('.edit-content').val(content);
                li.find('.edit-rating').val(rating);
                li.find('.edit-form').slideDown();
            });

            /** ‚ë¢ ÏàòÏ†ï ÏôÑÎ£å ‚Üí ÏÑúÎ≤Ñ PUT ÏöîÏ≤≠ */
            $(document).on('submit', '.edit-form', function (e) {
                e.preventDefault();

                const form = $(this);
                const li = form.closest('li');
                const reviewId = li.attr('data-review-id');
                const trackId = li.attr('data-track-id');
                const content = form.find('.edit-content').val().trim();
                const rating = form.find('.edit-rating').val();

                if (content === '' || rating === '') {
                    Swal.fire({
                        title: 'Î¶¨Î∑∞Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî',
                        text: 'Î¶¨Î∑∞Î•º ÏûÖÎ†•ÌïòÏßÄ ÏïäÏúºÏÖ®ÏäµÎãàÎã§.',
                        icon: 'error',
                        confirmButtonText: 'ÌôïÏù∏'
                    });
                    return;
                }
                $.ajax({
                    url: `/tracks/${trackId}/review/${reviewId}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ content, rating }),
                    success: function (updated) {
                        li.find('.content-text').text(updated.content).slideDown();
                        li.find('.name-and-score span span').text(updated.rating);
                        form.slideUp();
                        // console.log('ÌîÑÎûòÍ∑∏Î®ºÌä∏ ÏùëÎãµ ÌôïÏù∏:', html);
                        reloadScoreBox(trackId);
                    },
                    error: function (xhr) {
                        console.error(xhr.responseText);
                        Swal.fire({
                            title: 'Ïò§Î•ò',
                            text: 'Î¶¨Î∑∞ ÏàòÏ†ï Ï§ë Ïò§Î•ò Î∞úÏÉù.',
                            icon: 'error',
                            confirmButtonText: 'ÌôïÏù∏'
                        });
                    }
                });
            });

            /** ‚ë£ ÏàòÏ†ï Ï∑®ÏÜå */
            $(document).on('click', '.btn-danger', function () {
                const form = $(this).closest('.edit-form');
                const li = form.closest('li');

                // ÏàòÏ†ï Ìèº Ïà®ÍπÄ
                form.slideUp();

                // ÏõêÎûò Î¶¨Î∑∞ ÎÇ¥Ïö© Îã§Ïãú ÌëúÏãú
                li.find('.content-text').slideDown();
            });

            /** ‚ë§ ÏÇ≠Ï†ú */
            $(document).on('click', '.del-btn', function (e) {
                e.preventDefault();

                const li = $(this).closest('li');
                const reviewId = li.data('review-id');
                const trackId = li.data('track-id');

                Swal.fire({
                    title: 'Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
                    text: 'ÏÇ≠Ï†úÎêú Î¶¨Î∑∞Îäî Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ÏÇ≠Ï†ú',
                    cancelButtonText: 'Ï∑®ÏÜå'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `/tracks/${trackId}/review/${reviewId}`,
                            method: 'DELETE',
                            success: function () {
                                li.slideUp(() => li.remove());
                                reloadScoreBox(trackId);

                                Swal.fire({
                                    title: 'ÏÇ≠Ï†ú ÏôÑÎ£å',
                                    text: 'Î¶¨Î∑∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.',
                                    icon: 'success',
                                    confirmButtonText: 'ÌôïÏù∏'
                                });
                            },
                            error: function (xhr) {
                                console.error(xhr.responseText);
                                Swal.fire({
                                    title: 'Ïò§Î•ò',
                                    text: 'Î¶¨Î∑∞ ÏÇ≠Ï†ú Ï§ë Ïò§Î•ò Î∞úÏÉù.',
                                    icon: 'error',
                                    confirmButtonText: 'ÌôïÏù∏'
                                });
                            }
                        });
                    }
                });
            });
        });

        $(document).on("click", ".like-btn", function () {
            if (!isLogin) {
                Swal.fire({
                    title: 'Î°úÍ∑∏Ïù∏ÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî',
                    text: 'Î°úÍ∑∏Ïù∏Ïãú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî Í∏∞Îä•ÏûÖÎãàÎã§.',
                    icon: 'error',
                    confirmButtonText: 'ÌôïÏù∏'
                });
                return;
            }

            const btn = $(this);
            const reviewId = btn.data("review-id");
            const reviewType = btn.data("review-type");

            $.post(`/tracks/${reviewType.toLowerCase()}-reviews/${reviewId}/like`, {}, function (data) {
                btn.data("liked", data.liked);
                btn.text(data.liked ? '‚ù§Ô∏è' : 'ü§ç');

                // ÌïòÌä∏ Ïª§Ï°åÎã§ ÏûëÏïÑÏßÄÎäî Ïï†ÎãàÎ©îÏù¥ÏÖò
                btn.addClass("pop-heart");
                setTimeout(() => btn.removeClass("pop-heart"), 300);

                // Ï¢ãÏïÑÏöî Ïàò Ïä¨ÎùºÏù¥Îìú Ïï†ÎãàÎ©îÏù¥ÏÖò
                const countEl = $("#like-count-" + reviewId);
                const currentCount = parseInt(countEl.text(), 10);

                if (currentCount !== data.likeCount) {
                    countEl.slideUp(150, function () {
                        countEl.text(data.likeCount).slideDown(150);
                    });
                }
            }).fail(function (xhr) {
                Swal.fire({
                    title: 'Î°úÍ∑∏Ïù∏ÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî',
                    text: 'Î°úÍ∑∏Ïù∏Ïãú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî Í∏∞Îä•ÏûÖÎãàÎã§.',
                    icon: 'error',
                    confirmButtonText: 'ÌôïÏù∏'
                });
            });
        });

        $(document).on("click", ".report-btn", function () {
            if (!isLogin) {
                Swal.fire({
                    title: "Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§",
                    text: "Ïã†Í≥†ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.",
                    icon: "warning",
                    confirmButtonText: "ÌôïÏù∏"
                });
                return;
            }

            const reviewId = $(this).data("review-id");
            const reviewType = $(this).data("review-type");

            Swal.fire({
                title: "Ïã†Í≥†ÌïòÏãúÍ≤†ÏäµÎãàÍπå?",
                text: "Ìï¥Îãπ Î¶¨Î∑∞Î•º Ïã†Í≥†ÌïòÏãúÍ≤†ÏäµÎãàÍπå?",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Ïã†Í≥†",
                cancelButtonText: "Ï∑®ÏÜå"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post(`/tracks/reviews/${reviewType}/${reviewId}/report`, {}, function (data) {
                        Swal.fire({
                            title: "Ïã†Í≥† ÏôÑÎ£å",
                            text: `Ï¥ù Ïã†Í≥† Ïàò: ${data.reportCount}`,
                            icon: "success",
                            confirmButtonText: "ÌôïÏù∏"
                        });
                    }).fail(function (xhr) {
                        if (xhr.status === 429) {
                            Swal.fire({
                                title: "Ï§ëÎ≥µ Ïã†Í≥†",
                                text: "Ïù¥ÎØ∏ Ïã†Í≥†Ìïú Î¶¨Î∑∞ÏûÖÎãàÎã§.",
                                icon: "warning",
                                confirmButtonText: "ÌôïÏù∏"
                            });
                        } else if (xhr.status === 401) {
                            Swal.fire({
                                title: "Î°úÍ∑∏Ïù∏ ÌïÑÏöî",
                                text: "Ïã†Í≥†ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.",
                                icon: "warning",
                                confirmButtonText: "ÌôïÏù∏"
                            });
                        } else {
                            Swal.fire({
                                title: "Ïò§Î•ò",
                                text: "Ïã†Í≥† Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.",
                                icon: "error",
                                confirmButtonText: "ÌôïÏù∏"
                            });
                        }
                    });
                }
            });
        });
        $(document).ready(function () {
            $('#load-more-btn').on('click', function () {
                const $btn = $(this);
                let page = parseInt($btn.data('page'));
                const trackId = $btn.data('track-id');
                const size = 5;

                const nextPage = page + 1;

                $.ajax({
    url: `/tracks/${trackId}/reviews/more`,
    type: 'GET',
    data: { page: nextPage, size: size },
    success: function (fragmentHtml) {
        // Î®ºÏ†Ä ÏùëÎãµ fragmentÎ•º jQuery Í∞ùÏ≤¥Î°ú ÌååÏã±
        const $fragment = $(fragmentHtml);

        // ÌîåÎûòÍ∑∏ ÌÉúÍ∑∏Î•º fragment ÎÇ¥Î∂ÄÏóêÏÑú Ï∞æÏùå
        const $hasNextFlag = $fragment.filter('#has-next-flag');

        // ÌîåÎûòÍ∑∏ÏóêÏÑú Í∞í ÏùΩÍ∏∞ (boolean Î¨∏ÏûêÏó¥ ÎåÄÏùë)
        const hasNextRaw = $hasNextFlag.data('has-next');
        const hasNext = (hasNextRaw === true || hasNextRaw === 'true');

        // ÌîåÎûòÍ∑∏ ÌÉúÍ∑∏Îäî Ïã§Ï†ú DOMÏóêÎäî Ï∂îÍ∞Ä Ïïà Ìï¥ÎèÑ ÎêòÎØÄÎ°ú Ï†úÍ±∞
        $hasNextFlag.remove();

        // Î¶¨Î∑∞ Î¶¨Ïä§Ìä∏Ïóê ÎÇòÎ®∏ÏßÄ Î¶¨Î∑∞ liÎì§Îßå Ï∂îÍ∞Ä
        $('.review-list').append($fragment);

        if (hasNext) {
            $btn.data('page', nextPage); // ÌéòÏù¥ÏßÄ Ï¶ùÍ∞Ä
        } else {
            $btn.hide(); // ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº Ïà®ÍπÄ
        }
    },
    error: function () {
        alert('Î¶¨Î∑∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
});
            });
        });
    </script>



</body>

</html>