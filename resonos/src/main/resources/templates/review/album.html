<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/main_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="|${album.title} 리뷰|">앨범 리뷰</title>
    <th:block th:replace="~{fragments/link::album}"></th:block>
</head>

<body layout:fragment="content">
    <div class="wrapper">
        <!-- 앨범 카드 -->
        <div class="song-card">
            <div class="song-overall">
                <div class="song-img">
                    <img th:src="@{${album.coverImage}}" alt="">
                    <span class="center-pin"></span>
                </div>
            </div>
            <div class="song-info">
                <p id="headline" th:text="${album.title}">앨범제목</p>
                <p th:text="${#dates.format(album.releaseDate, 'yyyy-MM-dd')}">발매일</p>
                <a th:href="@{artists(id=${artist.id})}">
                    <p th:text="${artist.name}">아티스트 이름</p>
                </a>
                <p th:text="${album.label}">레이블</p>

                <th:block th:if="${score == null or score.averageScore == null}">
                    <p>아직 리뷰가 없어요 😅</p>
                </th:block>

                <th:block th:if="${score != null and score.averageScore != null}">
                    <p
                        th:text="|🔮 ${#numbers.formatDecimal(score.averageScore, 0, 0)}점 (✅리뷰 ${score.criticCount}개, 일반리뷰 ${score.userCount}개)|">
                    </p>
                </th:block>

                <!-- ✅ 좋아요 버튼은 항상 표시 -->
                <div style="display: flex; gap: 15px;">
                    <button type="button" class="btn btn-gold like-album-btn" th:data-album-id="${album.id}"
                        th:data-user-id="${loginUser != null ? loginUser.id : 0}" th:data-liked="${isAlbumLikedByUser}">
                        <span class="like-text"
                            th:text="${isAlbumLikedByUser != null and isAlbumLikedByUser ? '좋아요❤️' : '좋아요🤍'}"></span>
                        <span class="like-count" th:text="${albumLikeCount}">0</span>
                    </button>
                </div>
            </div>

            <div class="track-graphy">
                <div class="track-header">
                    <p id="headline" th:text="|${album.title}💿 Tracks|">수록곡</p>
                </div>
                <div class="track-container">
                    <!-- 반복문 구간 -->
                    <th:block th:each="track : ${tracks}">
                        <a th:href="@{tracks(id=${track.id})}">
                            <div class="track">
                                <div class="track-img">
                                    <img th:src="@{${album.coverImage}}" alt="">
                                    <span class="center-pin"></span>
                                </div>
                                <div class="track-info">
                                    <p id="subtitle" th:text="${track.title}">트랙명</p>
                                    <p th:text="|${track.formattedDuration}|">곡길이</p>
                                    <p th:text="|${track.trackNo}th Track|">번째곡</p>
                                </div>
                            </div>
                        </a>
                    </th:block>
                </div>
            </div>
        </div>
        <!-- 앨범 카드 끝 -->

        <!-- iframe -->
        <div class="iframe-card">
            <div class="spotify">
                <!-- 스포티파이 로그인 되어있지않을때 30초 미리듣기 오디오태그 -->
                <iframe th:src="|https://open.spotify.com/embed/track/${track.id}?utm_source=generator|" frameborder="0"
                    allowfullscreen allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                    loading="lazy">
                </iframe>
            </div>
            <div class="youtube">
                <th:block th:if="${!#strings.isEmpty(track.mvUrl)}">
                    <iframe width="560" height="315" th:src="|https://www.youtube.com/embed/${track.mvUrl}|"
                        title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
                    </iframe>
                </th:block>
                <!-- ② MV URL이 없을 때 → 준비중 이미지 -->
                <th:block th:if="${#strings.isEmpty(track.mvUrl)}">
                    <img th:src="@{/img/wait_plz.png}" alt="뮤직비디오 준비중" width="560" height="315"
                        style="object-fit:cover;">
                </th:block>
            </div>
        </div>
        <!-- iframe 카드 끝 -->

        <!-- 앨범 트랙리스트 분위기 뭐뭐.. -->
        <div class="info-card">
            <div class="info top5track">
                <p id="headline" th:text="|${album.title}💿 TOP${#lists.size(top5List)}🔥|">앨범 인기 TOP 5 트랙</p>
                <th:block th:each="tops, stat : ${top5List}">
                    <a th:href="@{tracks(id=${tops.id})}">
                        <p th:text="|${stat.count}. ${tops.title} ${track.formattedDuration}|"></p>
                    </a>
                </th:block>
            </div>
            <div class="info album-moods">
                <p id="headline">분위기로 노래찾기</p>
                <th:block th:if="${moodLabels == null || moodLabels.isEmpty()}">
                    <p>아직 아무도 분위기에 투표하지 않았어요 😅</p>
                </th:block>
                <th:block th:if="${moodLabels != null}">
                    <div class="mood-list" th:each="topMoods : ${moodLabels}">
                        <button class="btn btn-gold" th:text="|#${topMoods}|">분위기1</button>
                    </div>
                </th:block>
            </div>
            <div class="info pl-list">
                <p id="subtitle" th:text="|${album.title}의 트랙이 포함된 플리🎶|">이 트랙을 포함한 플리🎶</p>
                <p>오늘 헤어진 사람들은 위한 플리 ❤352</p>
                <p>혼자있고 싶어요,, ❤242</p>
                <p>😢😢😢😢😢😢😢😢😢 ❤122</p>
                <p>페페사랑단 플레이리스트 ❤64</p>
            </div>
        </div>
        <!-- 앨범 트랙리스트 분위기 뭐뭐..끝 -->

        <!-- 평점&리뷰 -->
        <div class="review-card">
            <p id="headline">평점 & 리뷰</p>
            <div th:fragment="scoreFragment">
                <div class="review-score">
                    <th:block th:if="${score == null or score.averageScore == null}">
                        <h1 id="headline" style="padding: 10px;">첫 리뷰를 작성해보세요 🤩</h1>
                    </th:block>
                    <th:block th:if="${score != null and score.averageScore != null}">
                        <h1 id="headline" th:text="|🔮 ${#numbers.formatDecimal(score.averageScore, 0, 0)}|"></h1>
                        <div class="score-bar">
                            <div class="score-fill"
                                th:style="'width:' + ${#numbers.formatDecimal(score.averageScore, 1, 1)} + '%'">
                                <span th:text="${#numbers.formatDecimal(score.averageScore, 0, 0)}"></span>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
            <div class="review-container">
                <ul class="review-list" th:insert="~{review/reviewFrag :: reviewItems(review=${review})}"></ul>
                <!-- 더보기 버튼 -->
                <div class="d-flex justify-content-center mb-1">
                    <div class="more-box d-flex gap-3" th:if="${hasNext}">
                        <button id="load-more-btn" data-page="1" th:data-album-id="${album.id}" class="btn btn-gold">리뷰
                            더보기</button>
                    </div>
                </div>
                <th:block th:if="${loginUser == null}">
                    <div class="d-flex gap-3 align-items-center">
                        <p id="headline" style="padding: 10px; margin-bottom: 0px">로그인시 리뷰작성과 점수투표가 가능합니다.</p>
                        <a id="login-review" href="/login" class="btn btn-gold">로그인</a>
                    </div>
                </th:block>
            </div>
            <!-- 페이지네이션 -->
            <div th:if="${loginUser != null}" class="reply">
                <form id="reviewForm">
                    <input type="hidden" id="albumId" th:value="${album.id}">
                    <textarea id="content" placeholder="리뷰를 입력해주세요" required></textarea>
                    <div class="score-and-submit">
                        <input type="number" id="rating" min="0" max="100" placeholder="0~100점" required>
                        <button type="submit" class="btn btn-gold">리뷰작성</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- 평점&리뷰 끝 -->

        <!-- 분위기 -->
        <!-- <div class="mood-card">
            <div class="chart">
                <th:block th:if="${isMoodEmpty}">
                    <p id="headline">아직 아무도 분위기에 투표하지 않았어요 😅</p>
                </th:block>
                <th:block th:if="${!isMoodEmpty}">
                    <canvas id="hexRadarChart"></canvas>
                </th:block>
            </div>
            <div class="mood-vote">
                <div class="vote-header">
                    <p id="headline">Mood Tags</p>
                </div>
                <div class="moods" th:data-user-id="${loginUser != null ? loginUser.id : 0}"
                    th:data-album-id="${album.id}" id="moodVoteContainer">
                    <th:block th:each="tag : ${tags}">
                        <label class="btn btn-gold mood-option"
                            th:classappend="${userVotedMoodId == tag.id} ? 'selected'">
                            <input type="radio" name="moodVote" th:value="${tag.id}"
                                th:checked="${userVotedMoodId == tag.id}" hidden />
                            <span th:text="${tag.name}">분위기</span>
                        </label>
                    </th:block>
                </div>
                <button class="btn btn-gold" id="submitMoodVote" th:if="${loginUser != null}">투표하기</button>
            </div>
        </div> -->
        <!-- 분위기 끝 -->


    </div>
    <script th:inline="javascript">
        const isLogin = [[${ loginUser != null ? 'true' : 'false'}]];
    </script>

    <!-- 로그인시 원래페이지로 -->
    <script>
        document.getElementById('login-review').addEventListener('click', e => {
            e.preventDefault()
            sessionStorage.setItem('returnTo', location.href)
            location.href = '/login'
        })
    </script>
    <!-- 드래그 슬라이드 자바스크립트 -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('.track-container');
            if (!container) return;

            /* 카드 하나 + gap = 270 + 20 */
            const STEP = 290;
            const THRESHOLD = 5;    // 클릭·드래그 구분
            const INTERVAL = 3000; // 자동 슬라이드 간격(ms)

            /* ─── 자동 슬라이드 ─── */
            let autoId = null;
            const startAuto = () => {
                clearInterval(autoId);
                autoId = setInterval(() => {
                    const max = container.scrollWidth - container.clientWidth;
                    const atEnd = Math.ceil(container.scrollLeft) >= max;
                    container.scrollTo({ left: atEnd ? 0 : container.scrollLeft + STEP, behavior: 'smooth' });
                }, INTERVAL);
            };
            const stopAuto = () => clearInterval(autoId);

            /* ─── 드래그 변수 ─── */
            let down = false, startX = 0, startScroll = 0, moved = 0;

            const dragStart = x => {
                down = true; moved = 0;
                startX = x - container.offsetLeft;
                startScroll = container.scrollLeft;
                container.classList.add('grabbing');
                stopAuto();
            };
            const dragMove = x => {
                if (!down) return;
                const delta = (x - container.offsetLeft) - startX;
                moved = Math.max(moved, Math.abs(delta));
                container.scrollLeft = startScroll - delta;
            };
            const dragEnd = () => {
                if (!down) return;
                down = false; container.classList.remove('grabbing');

                /* 스냅 위치 보정 */
                const rest = container.scrollLeft % STEP;
                const target = rest > STEP / 2
                    ? container.scrollLeft + (STEP - rest)
                    : container.scrollLeft - rest;
                container.scrollTo({ left: target, behavior: 'smooth' });
                startAuto();
            };

            /* ─── 이벤트 ─── */
            // 마우스
            container.addEventListener('mousedown', e => { dragStart(e.pageX); e.preventDefault(); });
            window.addEventListener('mousemove', e => dragMove(e.pageX));
            window.addEventListener('mouseup', dragEnd);

            // 터치
            container.addEventListener('touchstart', e => dragStart(e.touches[0].pageX), { passive: true });
            container.addEventListener('touchmove', e => dragMove(e.touches[0].pageX), { passive: false });
            container.addEventListener('touchend', dragEnd);

            // 클릭 vs 드래그
            container.addEventListener('click', e => {
                if (moved > THRESHOLD) { e.preventDefault(); e.stopPropagation(); }
            });

            // 호버 시 자동 슬라이드 일시 정지 (PC)
            container.addEventListener('mouseenter', stopAuto);
            container.addEventListener('mouseleave', startAuto);

            startAuto();      // 최초 실행
        });
    </script>
    <!-- 비동기 crud 기능 -->
    <script>
        $(document).ready(function () {
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
            const csrfToken = $('meta[name="_csrf"]').attr('content');

            // CSRF 설정
            $.ajaxSetup({
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                }
            });

            // 점수 박스 갱신
            function reloadScoreBox(albumId) {
                $.ajax({
                    url: `/albums/${albumId}/score-fragment`,
                    type: 'GET',
                    success: function (html) {
                        $('.review-score').html(html);
                    },
                    error: function () {
                        console.error("점수 갱신 실패");
                    }
                });
            }

            /** ① 등록 */
            $('#reviewForm').on('submit', function (e) {
                e.preventDefault();

                const albumId = $('#albumId').val();
                const content = $('#content').val().trim();
                const rating = $('#rating').val();

                if (content === '' || rating === '') {
                    Swal.fire('리뷰를 입력해 주세요', '리뷰를 입력하지 않으셨습니다.', 'error');
                    return;
                }

                $.ajax({
                    url: `/albums?id=${albumId}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ content, rating }),
                    success: function () {
                        Swal.fire({
                            title: '성공',
                            text: '리뷰를 등록 하였습니다.',
                            icon: 'success',
                            confirmButtonText: '확인'
                        }).then(() => {
                            reloadScoreBox(albumId);  // 점수 박스 먼저 다시 불러오고
                            // 방금 작성한 본인의 리뷰 프래그먼트만 불러오기
                            $.get(`/albums/${albumId}/my-review-frag`, function (html) {
                                const $html = $('<div>').html(html); // 문자열 → DOM으로 변환
                                const $newReview = $html.find('li.comment'); // li.comment 요소만 추출

                                if ($newReview.length) {
                                    $newReview.hide(); // 처음엔 안 보이게
                                    $('.review-list').append($newReview); // ul에 맨 앞에 추가
                                    $newReview.slideDown(); // 슬라이드로 등장
                                }
                            });
                        });
                    },
                    error: function (xhr) {
                        if (xhr.status === 409) {
                            Swal.fire('중복', '이미 리뷰를 작성했습니다.', 'warning');
                        } else {
                            Swal.fire('오류', '리뷰 등록 중 오류 발생.', 'error');
                        }
                    }
                });
            });

            /** ② 수정 버튼 클릭 → 폼 열기 + 기존 내용 채우기 */
            $(document).on('click', '.edit-btn', function (e) {
                e.preventDefault();

                const li = $(this).closest('li');
                const reviewId = li.attr('data-review-id');
                const albumId = li.attr('data-album-id');
                const contentText = li.find('.content-text');
                const content = contentText.text().trim();
                const rating = li.find('.name-and-score span span').text().trim();

                contentText.slideUp(200);
                li.find('.edit-content').val(content);
                li.find('.edit-rating').val(rating);
                li.find('.edit-form').slideDown();
            });

            /** ③ 수정 완료 → PUT 요청 */
            $(document).on('submit', '.edit-form', function (e) {
                e.preventDefault();

                const form = $(this);
                const li = form.closest('li');
                const reviewId = li.attr('data-review-id');
                const albumId = li.attr('data-album-id');
                const content = form.find('.edit-content').val().trim();
                const rating = form.find('.edit-rating').val();

                if (content === '' || rating === '') {
                    Swal.fire('리뷰를 입력해 주세요', '리뷰를 입력하지 않으셨습니다.', 'error');
                    return;
                }

                $.ajax({
                    url: `/albums/${albumId}/review/${reviewId}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ content, rating }),
                    success: function (updated) {
                        li.find('.content-text').text(updated.content).slideDown();
                        li.find('.name-and-score span span').text(updated.rating);
                        form.slideUp();
                        reloadScoreBox(albumId);
                    },
                    error: function (xhr) {
                        console.error(xhr.responseText);
                        Swal.fire('오류', '리뷰 수정 중 오류 발생.', 'error');
                    }
                });
            });

            /** ④ 수정 취소 */
            $(document).on('click', '.btn-danger', function () {
                const form = $(this).closest('.edit-form');
                const li = form.closest('li');
                form.slideUp();
                li.find('.content-text').slideDown();
            });

            /** ⑤ 삭제 */
            $(document).on('click', '.del-btn', function (e) {
                e.preventDefault();

                const li = $(this).closest('li');
                const reviewId = li.data('review-id');
                const albumId = li.data('album-id');

                Swal.fire({
                    title: '정말 삭제하시겠습니까?',
                    text: '삭제된 리뷰는 복구할 수 없습니다.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '삭제',
                    cancelButtonText: '취소'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `/albums/${albumId}/review/${reviewId}`,
                            method: 'DELETE',
                            success: function () {
                                li.slideUp(() => li.remove());
                                reloadScoreBox(albumId);

                                Swal.fire('삭제 완료', '리뷰가 삭제되었습니다.', 'success');
                            },
                            error: function (xhr) {
                                console.error(xhr.responseText);
                                Swal.fire('오류', '리뷰 삭제 중 오류 발생.', 'error');
                            }
                        });
                    }
                });
            });
        });

    </script>

    <!-- 리뷰 좋아요, 신고 비동기 -->
    <script>
        // 리뷰 좋아요
        $(document).on("click", ".like-btn", function () {
            if (!isLogin) {
                Swal.fire({
                    title: '로그인을 해주세요',
                    text: '로그인시 사용할 수 있는 기능입니다.',
                    icon: 'error',
                    confirmButtonText: '확인'
                });
                return;
            }

            const btn = $(this);
            const reviewId = btn.data("review-id");
            const reviewType = btn.data("review-type");

            $.post(`/albums/${reviewType.toLowerCase()}-reviews/${reviewId}/like`, {}, function (data) {
                btn.data("liked", data.liked);
                btn.text(data.liked ? '❤️' : '🤍');

                // 하트 애니메이션
                btn.addClass("pop-heart");
                setTimeout(() => btn.removeClass("pop-heart"), 300);

                // 좋아요 수 갱신
                const countEl = $("#like-count-" + reviewId);
                const currentCount = parseInt(countEl.text(), 10);

                if (currentCount !== data.likeCount) {
                    countEl.slideUp(150, function () {
                        countEl.text(data.likeCount).slideDown(150);
                    });
                }
            }).fail(function () {
                Swal.fire({
                    title: '로그인을 해주세요',
                    text: '로그인시 사용할 수 있는 기능입니다.',
                    icon: 'error',
                    confirmButtonText: '확인'
                });
            });
        });

        // 신고
        $(document).on("click", ".report-btn", function () {
            if (!isLogin) {
                Swal.fire({
                    title: "로그인이 필요합니다",
                    text: "신고하려면 로그인이 필요합니다.",
                    icon: "warning",
                    confirmButtonText: "확인"
                });
                return;
            }

            const reviewId = $(this).data("review-id");
            const reviewType = $(this).data("review-type");

            Swal.fire({
                title: "신고하시겠습니까?",
                text: "해당 리뷰를 신고하시겠습니까?",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "신고",
                cancelButtonText: "취소"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post(`/albums/reviews/${reviewType}/${reviewId}/report`, {}, function (data) {
                        Swal.fire({
                            title: "신고 완료",
                            text: `총 신고 수: ${data.reportCount}`,
                            icon: "success",
                            confirmButtonText: "확인"
                        });
                    }).fail(function (xhr) {
                        if (xhr.status === 429) {
                            Swal.fire("중복 신고", "이미 신고한 리뷰입니다.", "warning");
                        } else if (xhr.status === 401) {
                            Swal.fire("로그인 필요", "신고하려면 로그인이 필요합니다.", "warning");
                        } else {
                            Swal.fire("오류", "신고 중 오류가 발생했습니다.", "error");
                        }
                    });
                }
            });
        });

        // 리뷰 더보기
        $(document).ready(function () {
            $('#load-more-btn').on('click', function () {
                const $btn = $(this);
                let page = parseInt($btn.data('page'));
                const albumId = $btn.data('album-id');
                const size = 5;

                const nextPage = page + 1;

                $.ajax({
                    url: `/albums/${albumId}/reviews/more`,
                    type: 'GET',
                    data: { page: nextPage, size: size },
                    success: function (fragmentHtml) {
                        const $fragment = $('<div>').html(fragmentHtml);
                        $('.review-list').append($fragment.find('li.comment'));

                        const $hasNextFlag = $fragment.find('#has-next-flag');
                        const hasNextRaw = $hasNextFlag.data('has-next');
                        const hasNext = hasNextRaw === true || hasNextRaw === 'true';

                        $hasNextFlag.remove();

                        if (hasNext) {
                            $btn.data('page', nextPage);
                        } else {
                            $btn.hide();
                        }
                    },
                    error: function () {
                        alert('리뷰를 불러오는 중 오류가 발생했습니다.');
                    }
                });
            });
        });
    </script>

    <!-- 분위기, 앨범 관련 투표 -->
    <script>
        // 라디오버튼 체크시
        $(document).on('change', 'input[name="moodVote"]', function () {
            $('.mood-option').removeClass('selected pop-heart'); // 모든 버튼 초기화

            const $selected = $(this).closest('.mood-option');
            $selected.addClass('selected pop-heart'); // 선택된 버튼에 클래스 추가

            setTimeout(() => $selected.removeClass('pop-heart'), 300);
        });

        // 분위기 투표
        $(document).on('click', '#submitMoodVote', function () {
            const selectedMood = $('input[name="moodVote"]:checked').val();
            if (!selectedMood) {
                Swal.fire('분위기를 선택해주세요!');
                return;
            }

            const $container = $('#moodVoteContainer');
            const userId = $container.data('user-id');
            const albumId = $container.data('album-id');

            Swal.fire({
                title: '이 분위기로 투표할까요?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '네',
                cancelButtonText: '아니오'
            }).then(result => {
                if (!result.isConfirmed) return;

                $.ajax({
                    url: '/albums/vote-mood',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        userId: userId,
                        albumId: albumId,
                        mood: selectedMood
                    }),
                    success: function (data) {
                        const votedMoodId = data.votedMoodId;
                        const tags = data.moods;
                        const values = data.values;
                        const labels = data.labels;

                        // ✅ 무드 버튼 UI 갱신
                        $container.empty();
                        tags.forEach(tag => {
                            const selected = (tag.id === votedMoodId);
                            const html = `
                        <label class="btn btn-gold mood-option ${selected ? 'selected pop-heart' : ''}">
                            <input type="radio" name="moodVote" value="${tag.id}" ${selected ? 'checked' : ''} hidden />
                            <span>${tag.name}</span>
                        </label>
                    `;
                            $container.append(html);
                        });

                        // ✅ 차트 갱신
                        const $chartArea = $('.chart');
                        if (!Array.isArray(values) || values.length === 0) {
                            $chartArea.html(`<p id="headline">아직 아무도 분위기에 투표하지 않았어요 😅</p>`);
                        } else {
                            $chartArea.html(`<canvas id="hexRadarChart"></canvas>`);
                            renderMoodChart(labels, values);
                        }

                        setTimeout(() => {
                            $('.mood-option').removeClass('pop-heart');
                        }, 300);

                        Swal.fire('투표 완료!');
                    },
                    error: function () {
                        Swal.fire('투표에 실패했습니다.');
                    }
                });
            });
        });

        // 앨범 좋아요
        $(document).on('click', '.like-album-btn', function () {
            const $btn = $(this);
            const userId = $btn.data('user-id');
            const albumId = $btn.data('album-id');

            if (!userId || userId === 0) {
                Swal.fire('로그인이 필요합니다!');
                return;
            }

            $.ajax({
                url: '/albums/toggle-like',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ userId: userId, albumId: albumId }),
                success: function (res) {
                    console.log('응답:', res, '현재 버튼:', $btn);
                    const liked = res.liked
                    const count = res.count;

                    // 클릭한 버튼 내부의 like-text와 like-count만 변경
                    $btn.find('.like-text').text(liked ? '좋아요❤️' : '좋아요🤍');
                    $btn.find('.like-count').text(count);
                },
                error: function () {
                    Swal.fire('좋아요 처리에 실패했습니다.');
                }
            });
        });

    </script>

    <!-- 육각 그래프 스크립트 -->
    <!-- <script>
        // 육각 차트
        function renderMoodChart(labels, values) {
            const ctx = document.getElementById('hexRadarChart').getContext('2d');

            if (window.moodChartInstance) {
                window.moodChartInstance.destroy();
            }

            const maxValue = Math.max(...values);
            const roundedMax = Math.ceil(maxValue / 10) * 10;

            // ✅ 6개로 고정 (많으면 자르고, 적으면 채우기)
            labels = labels.slice(0, 6);
            values = values.slice(0, 6);
            while (labels.length < 6) {
                labels.push('');
                values.push(0);
            }

            window.moodChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Mood Votes',
                        data: values,
                        backgroundColor: 'rgba(212, 185, 127, 0.2)',
                        borderColor: '#D4B97F',
                        pointBackgroundColor: '#D4B97F'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            grid: { color: '#D4B97F' },
                            angleLines: { color: '#D4B97F' },
                            pointLabels: { color: '#D4B97F' },
                            ticks: {
                                stepSize: Math.ceil(roundedMax / 5), // 4단계로 분할
                                backdropColor: 'transparent'
                            },
                            min: 0,
                            max: roundedMax
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    </script>

    <script th:inline="javascript">
        const moodLabels = /*[[${moodLabels}]]*/[];
        const moodValues = /*[[${moodValues}]]*/[];

        renderMoodChart(moodLabels, moodValues);
    </script> -->

</body>

</html>