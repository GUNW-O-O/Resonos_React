<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/main_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="|${album.title} 리뷰|">앨범 리뷰</title>
    <th:block th:replace="~{fragments/link::album}"></th:block>
</head>

<body layout:fragment="content">
    <div class="wrapper">
        <!-- 앨범 카드 -->
        <div class="song-card">
            <div class="song-overall">
                <div class="song-img">
                    <img th:src="@{${album.coverImage}}" alt="">
                    <span class="center-pin"></span>
                </div>
            </div>
            <div class="song-info">
                <p id="headline" th:text="${album.title}">앨범제목</p>
                <a th:href="@{artists(id=${artist.id})}">
                    <p th:text="${artist.name}">아티스트 이름</p>
                </a>
                <p th:text="${#dates.format(album.releaseDate, 'yyyy-MM-dd')}">발매일</p>
                <p th:text="${album.label}">레이블</p>
                <p>🔮 99 (✅유저 30, 일반유저 300명)</p>
                <div>
                    <div class="btn btn-gold">❤ 팔로우</div>
                </div>
            </div>
            <div class="track-graphy">
                <div class="track-header">
                    <p id="headline" th:text="|${album.title}💿 Tracks|">수록곡</p>
                </div>
                <div class="track-container">
                    <!-- 반복문 구간 -->
                    <th:block th:each="track : ${tracks}">
                        <a th:href="@{tracks(id=${track.id})}">
                            <div class="track">
                                <div class="track-img">
                                    <img th:src="@{${album.coverImage}}" alt="">
                                    <span class="center-pin"></span>
                                </div>
                                <div class="track-info">
                                    <p id="subtitle" th:text="${track.title}">트랙명</p>
                                    <p th:text="|${track.formattedDuration}|">곡길이</p>
                                    <p th:text="|${track.trackNo}th Track|">번째곡</p>
                                </div>
                            </div>
                        </a>
                    </th:block>
                </div>
            </div>
        </div>
        <!-- 앨범 카드 끝 -->

        <!-- iframe -->
        <div class="iframe-card">
            <div class="spotify">
                <!-- 스포티파이 로그인 되어있지않을때 30초 미리듣기 오디오태그 -->
                <iframe th:src="|https://open.spotify.com/embed/track/${track.id}?utm_source=generator|" frameborder="0"
                    allowfullscreen allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                    loading="lazy">
                </iframe>
            </div>
            <div class="youtube">
                <th:block th:if="${!#strings.isEmpty(track.mvUrl)}">
                    <iframe width="560" height="315" th:src="|https://www.youtube.com/embed/${track.mvUrl}|"
                        title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
                    </iframe>
                </th:block>
                <!-- ② MV URL이 없을 때 → 준비중 이미지 -->
                <th:block th:if="${#strings.isEmpty(track.mvUrl)}">
                    <img th:src="@{/img/wait_plz.png}" alt="뮤직비디오 준비중" width="560" height="315"
                        style="object-fit:cover;">
                </th:block>
            </div>
        </div>
        <!-- iframe 카드 끝 -->

        <!-- 앨범 트랙리스트 분위기 뭐뭐.. -->
        <div class="info-card">
            <div class="info top5track">
                <p id="headline" th:text="|${album.title}💿 TOP${#lists.size(top5List)}🔥|">앨범 인기 TOP 5 트랙</p>
                <th:block th:each="tops, stat : ${top5List}">
                    <a th:href="@{tracks(id=${tops.id})}">
                        <p th:text="|${stat.count}. ${tops.title} ${track.formattedDuration}|"></p>
                    </a>
                </th:block>
            </div>
            <div class="info album-moods">
                <p id="headline" th:text="|${album.title}💿의 분위기|">앨범의 분위기</p>
                <div class="mood-list">
                    <button class="btn btn-gold">동해물과</button>
                    <button class="btn btn-gold">백두산이 마르고</button>
                    <button class="btn btn-gold">닳도록 하느</button>
                    <button class="btn btn-gold">닳도록 하느</button>
                </div>
            </div>
            <div class="info pl-list">
                <p id="subtitle" th:text="|${album.title}의 트랙이 포함된 플리🎶|">이 트랙을 포함한 플리🎶</p>
                <p>오늘 헤어진 사람들은 위한 플리 ❤352</p>
                <p>혼자있고 싶어요,, ❤242</p>
                <p>😢😢😢😢😢😢😢😢😢 ❤122</p>
                <p>페페사랑단 플레이리스트 ❤64</p>
            </div>
        </div>
        <!-- 앨범 트랙리스트 분위기 뭐뭐..끝 -->

        <!-- 평점&리뷰 -->
        <div class="review-card">
            <p id="headline">평점 & 리뷰</p>
            <div class="review-score">
                <h1 id="headline">🔮 99</h1>
                <div class="score-bar">
                    <div class="score-bar">
                        <div class="score-fill" style="width: 99%;">99</div>
                    </div>
                    <!-- <div class="score-fill" th:style="'width:' + ${score} + '%'">
                        <span th:text="${score}"></span>
                    </div> -->
                </div>
            </div>
            <div class="review-container">
                <ul class="comment-list">
                    <!-- 반복문 -->
                    <li class="comment">
                        <div class="name-and-score">
                            <p id="subtitle">페페사랑단</p>
                            <p> 🔮 100</p>
                        </div>
                        <div class="review-content">
                            <p>우리 페페 많이 사랑해주세요</p>
                        </div>
                        <div class="review-util">
                            <p>2025.05.21</p>
                            <a href="#">❤ 3</a>
                            <a href="#" id="report">신고</a>
                        </div>
                    </li>
                    <li class="comment">
                        <div class="name-and-score">
                            <p id="subtitle">페페사랑단</p>
                            <p> 🔮 100</p>
                        </div>
                        <div class="review-content">
                            <p>우리 페페 많이 사랑해주세요</p>
                        </div>
                        <div class="review-util">
                            <p>2025.05.21</p>
                            <a href="#">❤ 3</a>
                            <a href="#" id="report">신고</a>
                        </div>
                    </li>
                    <li class="comment">
                        <div class="name-and-score">
                            <p id="subtitle">페페사랑단</p>
                            <p> 🔮 100</p>
                        </div>
                        <div class="review-content">
                            <p>우리 페페 많이 사랑해주세요</p>
                        </div>
                        <div class="review-util">
                            <p>2025.05.21</p>
                            <a href="#">❤ 3</a>
                            <a href="#" id="report">신고</a>
                        </div>
                    </li>
                </ul>
            </div>
            <!-- 페이지네이션 -->
            <div class="reply">
                <form action="">
                    <textarea name="" id="" placeholder="리뷰를 입력해주세요"></textarea>
                    <div class="score-and-submit">
                        <input type="text" name="" id="" placeholder="점수를 입력해주세요">
                        <button class="btn btn-gold">리뷰작성</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- 평점&리뷰 끝 -->
        <!-- 분위기 -->
        <div class="mood-card">
            <div class="chart">
                <canvas id="hexRadarChart"></canvas>
            </div>
            <div class="mood-vote">
                <div class="vote-header">
                    <p id="headline">Mood Tag</p>
                </div>
                <div class="moods">
                    <!-- 분위기 반복문 -->
                    <div class="btn btn-gold">분위기1</div>
                    <div class="btn btn-gold">분위기1324</div>
                    <div class="btn btn-gold">분위기133</div>
                    <div class="btn btn-gold">분위기1</div>
                    <div class="btn btn-gold">분위기144</div>
                    <div class="btn btn-gold">분위기1</div>
                </div>
                <button class="btn btn-gold">분위기 투표</button>
            </div>
        </div>
        <!-- 분위기 끝 -->


    </div>
    <!-- <th:block th:replace="~{fragments/script::album}"></th:block> -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('.track-container');
            if (!container) return;

            /* 카드 하나 + gap = 270 + 20 */
            const STEP = 290;
            const THRESHOLD = 5;    // 클릭·드래그 구분
            const INTERVAL = 3000; // 자동 슬라이드 간격(ms)

            /* ─── 자동 슬라이드 ─── */
            let autoId = null;
            const startAuto = () => {
                clearInterval(autoId);
                autoId = setInterval(() => {
                    const max = container.scrollWidth - container.clientWidth;
                    const atEnd = Math.ceil(container.scrollLeft) >= max;
                    container.scrollTo({ left: atEnd ? 0 : container.scrollLeft + STEP, behavior: 'smooth' });
                }, INTERVAL);
            };
            const stopAuto = () => clearInterval(autoId);

            /* ─── 드래그 변수 ─── */
            let down = false, startX = 0, startScroll = 0, moved = 0;

            const dragStart = x => {
                down = true; moved = 0;
                startX = x - container.offsetLeft;
                startScroll = container.scrollLeft;
                container.classList.add('grabbing');
                stopAuto();
            };
            const dragMove = x => {
                if (!down) return;
                const delta = (x - container.offsetLeft) - startX;
                moved = Math.max(moved, Math.abs(delta));
                container.scrollLeft = startScroll - delta;
            };
            const dragEnd = () => {
                if (!down) return;
                down = false; container.classList.remove('grabbing');

                /* 스냅 위치 보정 */
                const rest = container.scrollLeft % STEP;
                const target = rest > STEP / 2
                    ? container.scrollLeft + (STEP - rest)
                    : container.scrollLeft - rest;
                container.scrollTo({ left: target, behavior: 'smooth' });
                startAuto();
            };

            /* ─── 이벤트 ─── */
            // 마우스
            container.addEventListener('mousedown', e => { dragStart(e.pageX); e.preventDefault(); });
            window.addEventListener('mousemove', e => dragMove(e.pageX));
            window.addEventListener('mouseup', dragEnd);

            // 터치
            container.addEventListener('touchstart', e => dragStart(e.touches[0].pageX), { passive: true });
            container.addEventListener('touchmove', e => dragMove(e.touches[0].pageX), { passive: false });
            container.addEventListener('touchend', dragEnd);

            // 클릭 vs 드래그
            container.addEventListener('click', e => {
                if (moved > THRESHOLD) { e.preventDefault(); e.stopPropagation(); }
            });

            // 호버 시 자동 슬라이드 일시 정지 (PC)
            container.addEventListener('mouseenter', stopAuto);
            container.addEventListener('mouseleave', startAuto);

            startAuto();      // 최초 실행
        });
    </script>
</body>

</html>